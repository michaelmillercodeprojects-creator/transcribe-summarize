{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4">Financial Audio Transcription</h1>
            <p class="lead">Upload audio/video files or paste URLs for AI-powered financial analysis</p>
        </div>

        <!-- File Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Audio/Video File</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="fileInput" name="file" 
                               accept=".mp3,.wav,.m4a,.mp4,.mov,.avi,.webm,.flv,.mkv" required>
                        <div class="form-text">
                            Supported formats: MP3, WAV, M4A, MP4, MOV, AVI, WEBM, FLV, MKV (Max: 500MB)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="emailFile" class="form-label">Email Results To (Optional)</label>
                        <input type="email" class="form-control" id="emailFile" name="email_recipient" 
                               placeholder="your-email@example.com">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>Upload & Process
                    </button>
                </form>
            </div>
        </div>

        <!-- URL Processing Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-link me-2"></i>Process URL</h5>
            </div>
            <div class="card-body">
                <form id="urlForm">
                    <div class="mb-3">
                        <label for="urlInput" class="form-label">Audio/Video URL</label>
                        <input type="url" class="form-control" id="urlInput" name="url" 
                               placeholder="https://youtube.com/watch?v=... or other video/audio URL" required>
                        <div class="form-text">
                            Supports YouTube, Vimeo, Dropbox, Google Drive, and other platforms
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="emailUrl" class="form-label">Email Results To (Optional)</label>
                        <input type="email" class="form-control" id="emailUrl" name="email_recipient" 
                               placeholder="your-email@example.com">
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play me-1"></i>Process URL
                    </button>
                </form>
            </div>
        </div>

        <!-- Processing Status -->
        <div id="processingStatus" class="card d-none">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Status</h5>
            </div>
            <div class="card-body">
                <div id="jobInfo" class="mb-3"></div>
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="statusMessage" class="text-muted"></div>
                <div id="downloadLinks" class="mt-3 d-none">
                    <h6>Download Results:</h6>
                    <div class="btn-group" role="group">
                        <a id="downloadTranscript" href="#" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-text me-1"></i>Transcript
                        </a>
                        <a id="downloadSummary" href="#" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-chart-bar me-1"></i>Analysis
                        </a>
                        <a id="downloadPdf" href="#" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-file-pdf me-1"></i>PDF Report
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div id="resultsSection" class="d-none">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Financial Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="summaryContent" class="analysis-content"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-text me-2"></i>Full Transcript</h5>
                </div>
                <div class="card-body">
                    <div id="transcriptContent" class="transcript-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="row mt-5">
    <div class="col-12">
        <div class="text-center mb-4">
            <h2>Key Features</h2>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <i class="fas fa-microphone-alt fa-3x text-primary mb-3"></i>
            <h5>AI Transcription</h5>
            <p>Powered by OpenAI Whisper for accurate audio-to-text conversion</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <i class="fas fa-brain fa-3x text-success mb-3"></i>
            <h5>Financial Analysis</h5>
            <p>GPT-4 powered analysis for market insights and trade ideas</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <i class="fas fa-envelope fa-3x text-info mb-3"></i>
            <h5>Email Delivery</h5>
            <p>Automatic email reports with formatted analysis and attachments</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentJobId = null;
let pollInterval = null;

// File upload form handler
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const fileInput = document.getElementById('fileInput');
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload.');
        return;
    }
    
    showProcessingStatus();
    updateStatus('Uploading file...', 0);
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentJobId = data.job_id;
            updateJobInfo(`Processing file: ${data.filename}`);
            startPolling();
        } else {
            alert(`Upload failed: ${data.error}`);
            hideProcessingStatus();
        }
    })
    .catch(error => {
        alert(`Upload failed: ${error.message}`);
        hideProcessingStatus();
    });
});

// URL processing form handler
document.getElementById('urlForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const url = document.getElementById('urlInput').value.trim();
    
    if (!url) {
        alert('Please enter a URL.');
        return;
    }
    
    showProcessingStatus();
    updateStatus('Starting URL processing...', 0);
    
    fetch('/process_url', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentJobId = data.job_id;
            updateJobInfo(`Processing URL: ${data.url}`);
            startPolling();
        } else {
            alert(`URL processing failed: ${data.error}`);
            hideProcessingStatus();
        }
    })
    .catch(error => {
        alert(`URL processing failed: ${error.message}`);
        hideProcessingStatus();
    });
});

function showProcessingStatus() {
    document.getElementById('processingStatus').classList.remove('d-none');
    document.getElementById('resultsSection').classList.add('d-none');
    document.getElementById('downloadLinks').classList.add('d-none');
}

function hideProcessingStatus() {
    document.getElementById('processingStatus').classList.add('d-none');
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function updateJobInfo(info) {
    document.getElementById('jobInfo').innerHTML = `<strong>Job ID:</strong> ${currentJobId}<br><strong>Task:</strong> ${info}`;
}

function updateStatus(message, progress) {
    document.getElementById('statusMessage').textContent = message;
    document.getElementById('progressBar').style.width = `${progress}%`;
    document.getElementById('progressBar').textContent = `${progress}%`;
}

function startPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    
    pollInterval = setInterval(() => {
        if (!currentJobId) return;
        
        fetch(`/job_status/${currentJobId}`)
        .then(response => response.json())
        .then(job => {
            updateStatus(job.message || 'Processing...', job.progress || 0);
            
            if (job.status === 'completed') {
                clearInterval(pollInterval);
                pollInterval = null;
                showResults(job);
            } else if (job.status === 'failed') {
                clearInterval(pollInterval);
                pollInterval = null;
                alert(`Processing failed: ${job.error || 'Unknown error'}`);
                hideProcessingStatus();
            }
        })
        .catch(error => {
            console.error('Polling error:', error);
        });
    }, 2000); // Poll every 2 seconds
}

function showResults(job) {
    // Show download links
    const downloadLinks = document.getElementById('downloadLinks');
    downloadLinks.classList.remove('d-none');
    
    document.getElementById('downloadTranscript').href = `/download/${job.id}/transcript`;
    document.getElementById('downloadSummary').href = `/download/${job.id}/summary`;
    document.getElementById('downloadPdf').href = `/download/${job.id}/pdf`;
    
    // Display results
    if (job.summary) {
        document.getElementById('summaryContent').innerHTML = formatText(job.summary);
        document.getElementById('resultsSection').classList.remove('d-none');
    }
    
    if (job.transcript) {
        document.getElementById('transcriptContent').innerHTML = formatText(job.transcript);
    }
}

function formatText(text) {
    // Simple text formatting for display
    return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}
</script>
{% endblock %}